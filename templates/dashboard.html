{% extends "layout.html" %}

{% block content %}
<div class="header">
    <div class="page-title">Dashboard</div>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <button onclick="openWidgetSettings()" class="btn-icon" title="Customize Widgets" style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; padding: 0.5rem 0.75rem; color: var(--text-muted); cursor: pointer;">
            <i class="fas fa-cog"></i>
        </button>
        <div class="date-display" style="color: var(--text-muted);">{{ now }}</div>
    </div>
</div>

<!-- Widget Settings Modal -->
<div id="widgetModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="glass" style="padding: 2rem; border-radius: 20px; max-width: 380px; width: 90%; position: relative;">
        <button onclick="closeWidgetSettings()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.3rem; line-height: 1;">&times;</button>
        
        <h3 style="margin-bottom: 1.75rem; display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem;">
            <i class="fas fa-th-large" style="color: var(--primary); font-size: 1.1rem;"></i>
            <span>Customize Dashboard</span>
        </h3>
        
        <div style="display: flex; flex-direction: column; gap: 1.25rem;">
            <label class="widget-checkbox-item">
                <input type="checkbox" id="widget-stats" checked onchange="toggleWidget('stats')">
                <span class="checkmark"></span>
                <span class="label-text">Summary Cards<br><small style="color: var(--text-muted); font-weight: 400;">(Income/Expense/Balance)</small></span>
            </label>
            <label class="widget-checkbox-item">
                <input type="checkbox" id="widget-charts" checked onchange="toggleWidget('charts')">
                <span class="checkmark"></span>
                <span class="label-text">Charts Section</span>
            </label>
            <label class="widget-checkbox-item">
                <input type="checkbox" id="widget-bills" checked onchange="toggleWidget('bills')">
                <span class="checkmark"></span>
                <span class="label-text">Upcoming Bills</span>
            </label>
            <label class="widget-checkbox-item">
                <input type="checkbox" id="widget-transactions" checked onchange="toggleWidget('transactions')">
                <span class="checkmark"></span>
                <span class="label-text">Recent Transactions</span>
            </label>
        </div>
        
        <button onclick="closeWidgetSettings()" class="btn-primary" style="margin-top: 2rem; padding: 0.875rem;">Done</button>
    </div>
</div>

<!-- Summary Cards -->
<div class="dashboard-grid" id="widget-stats-container">
    <div class="glass glass-card stat-card">
        <div class="stat-icon"
            style="background: rgba(16, 185, 129, 0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
            <i class="fas fa-arrow-down" style="color: var(--success);"></i>
        </div>
        <div class="stat-label">Total Income</div>
        <div class="stat-value income-text" id="total-income">$0.00</div>
    </div>
    <div class="glass glass-card stat-card">
        <div class="stat-icon"
            style="background: rgba(239, 68, 68, 0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
            <i class="fas fa-arrow-up" style="color: var(--danger);"></i>
        </div>
        <div class="stat-label">Total Expense</div>
        <div class="stat-value expense-text" id="total-expense">$0.00</div>
    </div>
    <div class="glass glass-card stat-card">
        <div class="stat-icon"
            style="background: rgba(114, 105, 227, 0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
            <i class="fas fa-wallet" style="color: var(--primary);"></i>
        </div>
        <div class="stat-label">Total Balance</div>
        <div class="stat-value" id="total-balance">$0.00</div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-section" id="widget-charts-container">
    <div class="glass glass-card chart-container">
        <h3 style="margin-bottom: 1rem; color: var(--text-muted); font-weight: 500;">Income vs Expense vs Bills</h3>
        <canvas id="barChart"></canvas>
    </div>
    <div class="glass glass-card chart-container">
        <h3 style="margin-bottom: 1rem; color: var(--text-muted); font-weight: 500;">Top Expenses</h3>
        <canvas id="pieChart"></canvas>
    </div>
    <div class="glass glass-card chart-container">
        <h3 style="margin-bottom: 1rem; color: var(--text-muted); font-weight: 500;">Monthly Income & Expense</h3>
        <canvas id="monthlyChart"></canvas>
    </div>
</div>

<!-- Bills & Recent Transactions Row -->
<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; margin-top: 1.5rem;" id="widget-bottom-row">
    <!-- Upcoming Bills -->
    <div class="glass glass-card" id="widget-bills-container" style="padding: 0; overflow: hidden;">
        <div style="padding: 1.25rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border);">
            <h3 style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-file-invoice-dollar" style="color: var(--primary);"></i> Upcoming Bills
            </h3>
            <a href="{{ url_for('bills') }}" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">View All</a>
        </div>
        
        <!-- Bills Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; padding: 1rem;">
            <div style="background: rgba(231, 76, 60, 0.1); padding: 0.75rem; border-radius: 10px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #e74c3c;" id="overdue-bills">0</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Overdue</div>
            </div>
            <div style="background: rgba(243, 156, 18, 0.1); padding: 0.75rem; border-radius: 10px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #f39c12;" id="due-soon-bills">0</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Due Soon</div>
            </div>
            <div style="background: rgba(52, 152, 219, 0.1); padding: 0.75rem; border-radius: 10px; text-align: center; grid-column: span 2;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #3498db;" id="pending-amount">â‚¹0</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Total Pending</div>
            </div>
        </div>
        
        <!-- Upcoming Bills List -->
        <div style="padding: 0 1rem 1rem 1rem; max-height: 250px; overflow-y: auto;" id="upcoming-bills-list">
            <div style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.9rem;">
                <i class="fas fa-check-circle" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 0.5rem;"></i>
                No pending bills
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="glass glass-card" id="widget-transactions-container" style="padding: 0; overflow: hidden;">
        <div
            style="padding: 1.25rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border);">
            <h3 style="font-weight: 600;">Recent Transactions</h3>
            <a href="{{ url_for('transactions') }}"
                style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">View All</a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="transactions-body">
                    <!-- Javascript will populate this -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
    // Force dashboard data fetch on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof fetchDashboardData === 'function') {
            fetchDashboardData();
        }
        loadWidgetSettings();
    });

    // Widget Settings Functions
    function openWidgetSettings() {
        document.getElementById('widgetModal').style.display = 'flex';
    }

    function closeWidgetSettings() {
        document.getElementById('widgetModal').style.display = 'none';
    }

    function toggleWidget(widget) {
        const container = document.getElementById(`widget-${widget}-container`);
        const checkbox = document.getElementById(`widget-${widget}`);
        
        if (container) {
            container.style.display = checkbox.checked ? '' : 'none';
        }
        
        // Handle bottom row visibility
        if (widget === 'bills' || widget === 'transactions') {
            updateBottomRowLayout();
        }
        
        saveWidgetSettings();
    }

    function updateBottomRowLayout() {
        const billsVisible = document.getElementById('widget-bills').checked;
        const transactionsVisible = document.getElementById('widget-transactions').checked;
        const bottomRow = document.getElementById('widget-bottom-row');
        
        if (!billsVisible && !transactionsVisible) {
            bottomRow.style.display = 'none';
        } else if (billsVisible && transactionsVisible) {
            bottomRow.style.display = 'grid';
            bottomRow.style.gridTemplateColumns = '1fr 2fr';
        } else {
            bottomRow.style.display = 'grid';
            bottomRow.style.gridTemplateColumns = '1fr';
        }
    }

    function saveWidgetSettings() {
        const settings = {
            stats: document.getElementById('widget-stats').checked,
            charts: document.getElementById('widget-charts').checked,
            bills: document.getElementById('widget-bills').checked,
            transactions: document.getElementById('widget-transactions').checked
        };
        localStorage.setItem('dashboardWidgets', JSON.stringify(settings));
    }

    function loadWidgetSettings() {
        const saved = localStorage.getItem('dashboardWidgets');
        if (saved) {
            const settings = JSON.parse(saved);
            Object.keys(settings).forEach(widget => {
                const checkbox = document.getElementById(`widget-${widget}`);
                if (checkbox) {
                    checkbox.checked = settings[widget];
                    toggleWidget(widget);
                }
            });
        }
    }

    // Close modal on outside click
    document.getElementById('widgetModal').addEventListener('click', function(e) {
        if (e.target === this) closeWidgetSettings();
    });
</script>
{% endblock %}