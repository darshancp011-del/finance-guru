{% extends "layout.html" %}

{% block content %}
<div class="header">
    <div class="page-title">My Profile</div>
</div>

<div class="glass glass-card" style="max-width: 600px; margin: 0 auto;">
    <form action="{{ url_for('profile') }}" method="POST" enctype="multipart/form-data"
        style="display: flex; flex-direction: column; gap: 2rem;">

        <!-- Profile Picture Section -->
        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
            <div
                style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid var(--glass-border); position: relative;">
                <img id="profile-preview"
                    src="{{ url_for('static', filename='uploads/' + user.profile_pic) if user.profile_pic != 'default.png' else 'https://ui-avatars.com/api/?name=' + user.username + '&background=random' }}"
                    alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <label for="profile_pic" class="btn-primary"
                style="cursor: pointer; padding: 0.5rem 1rem; font-size: 0.9rem;">
                <i class="fas fa-camera"></i> Change Photo
            </label>
            <input type="file" name="profile_pic" id="profile_pic" accept="image/*" style="display: none;"
                onchange="previewImage(this)">
            <span id="img-preview-text" style="font-size: 0.8rem; color: var(--text-muted);"></span>
        </div>

        <!-- Details Section -->
        <div style="display: grid; gap: 1.5rem;">
            <div class="input-group" style="margin: 0;">
                <label
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Username</label>
                <input type="text" name="username" value="{{ user.username }}" required>
            </div>

            <div class="input-group" style="margin: 0;">
                <label
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Email</label>
                <input type="email" name="email" value="{{ user.email }}" required>
            </div>

            <div class="input-group" style="margin: 0;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Phone
                    Number</label>
                <input type="tel" name="phone" value="{{ user.phone or '' }}" placeholder="+91 9876543210">
            </div>

            <div class="input-group" style="margin: 0;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Job
                    Title</label>
                <input type="text" name="job_title" value="{{ user.job_title or '' }}" placeholder="Software Engineer">
            </div>

            <div class="input-group" style="grid-column: span 2;">
                <label
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Bio</label>
                <textarea name="bio" rows="3" placeholder="Tell us a little about yourself..."
                    style="width: 100%; padding: 1rem; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--glass-border); border-radius: 12px; color: white;">{{ user.bio or '' }}</textarea>
            </div>
        </div>

        <button type="submit" class="btn-primary" style="margin-top: 1rem;">Save Changes</button>
    </form>

    <!-- Change Password Section -->
    <div style="margin-top: 2.5rem; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
        <h3 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 1.1rem;">
            <i class="fas fa-lock" style="margin-right: 0.5rem;"></i>Change Password
        </h3>
        <form action="{{ url_for('change_password') }}" method="POST" id="passwordForm" style="display: grid; gap: 1.5rem;">
            <div class="input-group" style="margin: 0;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Current Password</label>
                <div style="position: relative;">
                    <input type="password" name="current_password" id="currentPassword" required
                        style="padding-right: 40px;">
                    <button type="button" onclick="togglePassword('currentPassword', this)" 
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer;">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <div class="input-group" style="margin: 0;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">New Password</label>
                <div style="position: relative;">
                    <input type="password" name="new_password" id="newPassword" required minlength="6"
                        style="padding-right: 40px;">
                    <button type="button" onclick="togglePassword('newPassword', this)"
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer;">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <small style="color: var(--text-muted); font-size: 0.75rem;">Minimum 6 characters</small>
            </div>
            <div class="input-group" style="margin: 0;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Confirm New Password</label>
                <div style="position: relative;">
                    <input type="password" name="confirm_password" id="confirmPassword" required
                        style="padding-right: 40px;">
                    <button type="button" onclick="togglePassword('confirmPassword', this)"
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer;">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <button type="submit" class="btn-primary" style="background: linear-gradient(135deg, var(--secondary), #1a8a85);">
                <i class="fas fa-key" style="margin-right: 0.5rem;"></i>Update Password
            </button>
        </form>
    </div>

    <!-- Danger Zone -->
    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
        <h3 style="color: #ef4444; margin-bottom: 1rem; font-size: 1.1rem;">Danger Zone</h3>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
            Deleting your account is permanent. All your data (transactions, budgets, goals) will be efficiently wiped
            out.
        </p>
        <button onclick="confirmDelete()"
            style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
            <i class="fas fa-trash-alt" style="margin-right: 0.5rem;"></i> Delete Account
        </button>
    </div>

    <!-- Hidden Delete Form -->
    <form id="deleteForm" action="{{ url_for('delete_account') }}" method="POST" style="display: none;"></form>
</div>

<script>
    function confirmDelete() {
        if (confirm("Are you sure you want to delete your account? This action CANNOT be undone.")) {
            if (confirm("Really sure? All data will be lost forever.")) {
                document.getElementById('deleteForm').submit();
            }
        }
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('profile-preview').src = e.target.result;
                document.getElementById('img-preview-text').innerText = input.files[0].name;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        const icon = btn.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }

    // Validate password form
    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        const newPwd = document.getElementById('newPassword').value;
        const confirmPwd = document.getElementById('confirmPassword').value;
        
        if (newPwd !== confirmPwd) {
            e.preventDefault();
            alert('New passwords do not match!');
            return false;
        }
        
        if (newPwd.length < 6) {
            e.preventDefault();
            alert('Password must be at least 6 characters!');
            return false;
        }
    });
</script>
{% endblock %}